using System.Collections;
using System.Collections.Generic;
using UnityEngine;

public class PlayerController : MonoBehaviour
{
    [SerializeField]
    private float walkSpeed;
    [SerializeField]
    private float runSpeed;
    //???? ????? ??? ???
    [SerializeField]
    private float crunchSpeed;
    private float applySpeed;

    //?????? ë³???? : ???ê°??????¼ë?? ???ë¡? ??¼ë??ë§???? ì¹????ê²? ë§???¤ê????¸ê??
    [SerializeField]
    private float jumpForce;

    //????
    private bool isWalk = false;
    private bool isRun = false;
    private bool isGround = true;
    private bool isCrunch = false;

    //??? ?? ??
    private Vector3 lastPos;

    //???? ??? ??? ???? ??
    [SerializeField]
    private float crunchPosY;
    private float originPosY;
    private float applyCrunchPosY;
    // ??? ì°?ì§? ???ë¶?
    private CapsuleCollider capsuleCollider;



    // ì¹´ë????? ë¯¼ê?????
    [SerializeField]
    private float lookSensitivity;

    [SerializeField]
    private float cameraRotationLimit;
    private float currentCameraRotationX;

    [SerializeField]
    private Camera theCamera;
    private Rigidbody myRigid;
    private GunContoroller theGuncontroller;
    private CrossHair theCrossHair;

    // Start is called before the first frame update
    void Start()
    {

        capsuleCollider = GetComponent<CapsuleCollider>();
        myRigid = GetComponent<Rigidbody>();
        theGuncontroller = FindObjectOfType<GunContoroller>();
        theCrossHair = FindObjectOfType<CrossHair>();

        //???? ???? ?? ?? ??? ?? ??? ??? ???? ?? ??? ???? ??? ??? ??
        applySpeed = walkSpeed;
        originPosY = theCamera.transform.localPosition.y;
        applyCrunchPosY = originPosY;

    }

    // Update is called once per frame
    void Update()
    {
        IsGround();
        TryJump();
        //???ë¦????ì§? ê±·ë??ì§? êµ?ë¶??????? ?????? ë°??????? Move?????? ?????? ?????? ê²? (êµ?ë¶???? ??????ë¥? ê²°ì?????ê³? ë¬´ë???????? ???ì§???¼ê±°ê¸? ???ë¬¸ì??)
        TryRun();
        TryCrunch();
        Move();
        MoveCheck();
        CameraRotation();
        CharacterRatation();
    }

    private void TryCrunch()
    {
        if (Input.GetKeyDown(KeyCode.LeftControl))
        {
            Crunch();
        }
    }

    private void Crunch()
    {
        //isCrunch? ?????? ??
        isCrunch = !isCrunch;
        theCrossHair.CrounchingAnimation(isCrunch);

        if (isCrunch)
        {
            applySpeed = crunchSpeed;
            applyCrunchPosY = crunchPosY;
        }
        else
        {
            applySpeed = walkSpeed;
            applyCrunchPosY = originPosY;

        }
        // local? y?? ????? ??? ??? vector? ??? ?????? ??.
        // theCamera.transform.localPosition = new Vector3(theCamera.transform.localPosition.x, applyCrunchPosY, theCamera.transform.localPosition.z);
        StartCoroutine(CrounchCoroutine());

    }

    //?? ??? ???? ?? ??? ??? ?? ????
    IEnumerator CrounchCoroutine()
    {
        float posY = theCamera.transform.localPosition.y;
        int count = 0;

        while (posY != applyCrunchPosY)
        {
            count++;
            posY = Mathf.Lerp(posY, applyCrunchPosY, 0.1f);
            theCamera.transform.localPosition = new Vector3(0, posY, 0);
            // ?? ???? ???? ???? applyCrunchPosy? ??? ????
            if (count >= 15)
            {
                break;
            }
            //????? ??
            yield return null;
        }

        theCamera.transform.localPosition = new Vector3(0, applyCrunchPosY, 0);
        //1? ?? ???? ??? ?? ? ?? ???? ??
        //???? ????? ???? ??? ?? ??? ???? ??? ??? ??? ???? ??? ???? ???? ??? ??? ????? ???
        // yield return new WaitForSeconds(1f);
    }
    private void IsGround()
    {
        // ê´??????? ?´ì?? ê·? ê´??????? ?????­ì?? ??¿ì?????ì§? ?????¸í????? ë°?ë²? (?????´ì??ë¥? ë°???¥ì?¼ë?? ?´ì?? ?????? ?????´ì??ê°? ë°???¥ê³¼ ??¿ì????????ì§?ë¡? ?????? ì¡´ì????????ì§? êµ?ë¶?)
        //???ê¸°ì?? Position??? ?????°ê?? vectorë¥? ???????????? ??´ì????? ìº?ë¦­í?°ê?? ??????ê°?ë©? position??? ê³???? ë°???¥ì?? ??????ê¸? ???ë¬¸ì?? ë°???¥ì?? ?????¼ì?? vectorë¥? ?????????ë©? ??¼ì????? ë°???¥ì?¼ë?? ??¤ì??ê°????
        isGround = Physics.Raycast(transform.position, Vector3.down, capsuleCollider.bounds.extents.y + 0.1f);
    }
    private void TryJump()
    {
        if (Input.GetKeyDown(KeyCode.Space) && isGround == true)
        {
            Jump();
        }
    }

    private void Jump()
    {
        if (isCrunch)
        {
            //?? ?? ???? ??? ???? ? ?? ??? ???? ??? ???
            Crunch();
        }
        myRigid.velocity = transform.up * jumpForce;
    }

    private void TryRun()
    {
        if (Input.GetKey(KeyCode.LeftShift))
        {
            Running();
        }
        if (Input.GetKeyUp(KeyCode.LeftShift))
        {
            RunningCancle();
        }
    }

    private void Running()
    {
        if (isCrunch)
        {
            Crunch();
        }

        theGuncontroller.CancleFineSight();

        isRun = true;
        theCrossHair.RunningAnimation(isRun);
        applySpeed = runSpeed;

    }

    private void RunningCancle()
    {
        isRun = false;
        applySpeed = walkSpeed;
        theCrossHair.RunningAnimation(isRun);
    }

    private void Move()
    {
        // ??? ??? 1 ??-1 ???? 0
        float MoveDirX = Input.GetAxisRaw("Horizontal");
        // ??? 3D??? z? ?,?
        float MoveDirZ = Input.GetAxisRaw("Vertical");

        Vector3 MoveHorizontal = transform.right * MoveDirX;
        Vector3 MoveVertical = transform.forward * MoveDirZ;

        // ? ?? ?? ?? ??? ?? (normalized = ?? 1? ??? ?? ?? ??? ??? ??)
        Vector3 Velocity = (MoveHorizontal + MoveVertical).normalized * applySpeed;

        //Time.deltaTime? ???? ???? ?? ?? 0.0016??? ????? ??
        myRigid.MovePosition(transform.position + Velocity * Time.deltaTime);

    }

    private void MoveCheck()
    {
        if(!isRun && !isCrunch) {
            if(Vector3.Distance(lastPos, transform.position) >= 0.01f) 
                isWalk = true;
            else
                isWalk = false;
            
        // theCrossHair.WalkingAnimation(isWalk);
        lastPos = transform.position;
        }
        
    }

    private void CameraRotation()
    {
        // ????? x,y? ???? 2????. ??? x?? ??? y? ??? ?
        float xRotation = Input.GetAxisRaw("Mouse Y");
        float cameraRotationX = xRotation * lookSensitivity;
        currentCameraRotationX -= cameraRotationX;
        // Mathf.Clamp? ??? ?? ?? ? ??? ?? ? ???? ?????? ??? ???? ??
        currentCameraRotationX = Mathf.Clamp(currentCameraRotationX, -cameraRotationLimit, cameraRotationLimit);

        theCamera.transform.localEulerAngles = new Vector3(currentCameraRotationX, 0f, 0f);
    }

    private void CharacterRatation()
    {
        float yRotation = Input.GetAxisRaw("Mouse X");
        Vector3 characterRotationY = new Vector3(0f, yRotation, 0f) * lookSensitivity;
        myRigid.MoveRotation(myRigid.rotation * Quaternion.Euler(characterRotationY));
    }


}
